<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Prompt Manager (Fixed)</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --danger-color: #ef4444;
            --border-color: #e2e8f0;
            --background-light: #f8fafc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            width: 1200px; height: 850px; background: rgba(255, 255, 255, 0.95);
            border-radius: 16px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 16px 20px; flex-shrink: 0; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .nav-tabs { display: flex; background: rgba(255, 255, 255, 0.8); padding: 8px; flex-shrink: 0; }
        .nav-tab { flex: 1; padding: 10px 16px; border: none; background: none; cursor: pointer; border-radius: 8px; font-weight: 500; transition: all 0.2s; color: #64748b; font-size: 13px; }
        .nav-tab.active { background: white; color: var(--primary-color); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .content { flex: 1; overflow: hidden; }
        .tab-content { height: 100%; display: none; }
        .tab-content.active { display: flex; }
        .btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; border: none; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; }
        .btn-secondary { background: white; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover { background: var(--primary-color); color: white; }
        .btn-secondary.active { background: var(--primary-color); color: white; }
        .btn-danger { background: white; color: var(--danger-color); border: 2px solid var(--danger-color); }
        .btn-danger:hover { background: var(--danger-color); color: white; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 13px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; }
        .form-textarea { resize: vertical; min-height: 80px; max-height: 200px; }
        .long-text-handler { overflow-wrap: break-word; word-break: break-all; min-width: 0; }
        .prompt-creation-container { display: flex; height: 100%; width: 100%; }
        .parts-library-panel { width: 400px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: var(--background-light); flex-shrink: 0; }
        .search-box { padding: 16px; flex-shrink: 0; }
        .categories { flex: 1; overflow-y: auto; padding: 0 16px 16px; }
        .category { margin-bottom: 12px; }
        .category-header { 
            padding: 10px 12px; background: #f1f5f9; border-radius: 8px; font-weight: 600; color: #6b7280; font-size: 13px; cursor: pointer; 
            display: flex; align-items: center; gap: 8px;
        }
        .category-toggle { font-size: 14px; color: #9ca3af; }
        .category-content { display: none; padding-top: 8px; }
        .category.expanded .category-content { display: block; }
        .prompt-part { display: flex; align-items: flex-start; gap: 8px; padding: 8px 12px; margin: 4px 0; background: white; border-radius: 6px; cursor: pointer; }
        .prompt-en { font-size: 14px; }
        .prompt-ja { font-size: 12px; color: #666666; }
        .prompt-part-main { flex: 1; }
        .add-btn { width: 22px; height: 22px; border: none; background: var(--primary-color); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .add-btn.selected { background: #f59e0b; color: #fff; }
        .add-btn .icon-minus {
            width: 16px;
            height: 16px;
            display: block;
        }
        .prompt-workspace { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        .current-prompt { background: white; border-radius: 12px; border: 2px solid var(--border-color); flex: 3; display: flex; margin-bottom: 16px; }
        .prompt-input { width: 100%; height: 100%; border: none; outline: none; font-size: 14px; line-height: 1.6; resize: none; background: transparent; padding: 16px; }
        .translation-display { background: #fafafa; border-radius: 8px; border: 1px solid var(--border-color); padding: 16px; margin-bottom: 16px; flex: 2; display: flex; flex-direction: column; }
        .translation-input { width: 100%; height: 100%; border: none; outline: none; font-size: 13px; line-height: 1.5; resize: none; background: transparent; color: #64748b; }
        .prompt-actions { display: flex; gap: 8px; }
        .parts-content { display: flex; gap: 0; height: 100%; }
        .parts-section { background: var(--background-light); border-radius: 0; padding: 20px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; min-width: 0; }
        .parts-section.category-mgmt { flex: 0 0 350px; }
        .parts-section.part-edit { flex: 0 0 350px; max-width: 350px; }
        .parts-main { flex: 1; background: white; padding: 20px; min-width: 0; display: flex; flex-direction: column; height: 100%; }
        .section-title { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
        .card { background: white; border-radius: 8px; padding: 12px; border: 1px solid var(--border-color); margin-bottom: 12px; display: flex; gap: 8px; align-items: flex-start; width: 100%; position: relative; }
        .category-scroll-area { flex: 1; overflow-y: auto; padding-right: 8px; }
        .category-reorder-item { 
            display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px; font-size: 13px; 
            border: 1px solid var(--border-color); margin-bottom: 6px; justify-content: space-between;
        }
        .category-reorder-item.dragging { opacity: 0.5; }
        .drag-handle { cursor: grab; color: #94a3b8; }
        .category-name { flex: 1; }
        .templates-container { display: flex; height: 100%; gap: 0; }
        .template-edit-panel { flex: 0 0 400px; max-width: 400px; background: var(--background-light); border-radius: 0; padding: 20px; border-right: 1px solid var(--border-color); min-width: 0; display: flex; flex-direction: column; }
        .template-list-panel { width: 800px; min-width: 0; background: white; display: flex; flex-direction: column; }
        .template-search-fixed { padding: 16px 20px 0 20px; flex-shrink: 0; background: white; border-bottom: 1px solid var(--border-color); }
        .template-list-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .template-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .template-card { background: #f9f9f9; border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); position: relative; }
        .template-card-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px; }
        .template-card-title { font-weight: 600; border: none; background: transparent; flex: 1; padding: 4px; font-size: 16px; }
        .template-card-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .template-card-details { font-size: 12px; color: #64748b; background: #f0f0f0; padding: 8px; border-radius: 6px; max-height: 80px; overflow-y: auto; }
        .settings-section { padding: 20px; width: 100%; overflow-y: auto; }
        .export-btn { padding: 12px 16px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .import-label { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .export-button { background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); }
        .reset-button { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .image-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1001; cursor: pointer; }
        .image-modal img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        .modal-content { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 700px; height: 80%; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-body { flex: 1; display: flex; }
        .modal-textarea { width: 100%; height: 100%; font-family: monospace; font-size: 14px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        .modal-footer { margin-top: 16px; display: flex; justify-content: flex-end; gap: 10px; }
        .form-input:disabled, .form-textarea:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .thumbnail-preview { width: 100%; height: 120px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af; cursor: pointer; transition: border-color 0.2s; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .thumbnail-preview:hover { border-color: var(--primary-color); }
        .thumbnail-preview.has-image { border-style: solid; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 2000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        .tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; line-height: 1.4; max-width: 300px; word-wrap: break-word; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .tooltip.show { opacity: 1; }
        .json-management { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin: 20px 0; }
        .json-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .json-item { display: flex; align-items: center; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 6px; cursor: grab; transition: box-shadow 0.2s; }
    .json-item.active { border-color: var(--primary-color); background: #f0f7ff; }
    .json-item.dragging { opacity: 0.5; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .drag-handle { font-size: 20px; margin-right: 8px; cursor: grab; user-select: none; color: #888; }
    .json-item-name { font-weight: 500; flex: 1; }
    .json-item-actions { display: flex; gap: 4px; }
        .json-add-form { display: flex; gap: 8px; margin-bottom: 12px; }
        .storage-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 6px; font-size: 12px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>🎨 AI Prompt Manager</h1></div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="creation">プロンプト作成</button>
            <button class="nav-tab" data-tab="parts">パーツ</button>
            <button class="nav-tab" data-tab="templates">テンプレート</button>
            <button class="nav-tab" data-tab="settings">設定</button>
        </div>

        <div class="content">
            <div id="creation-tab" class="tab-content active">
                <div class="prompt-creation-container">
                    <div class="parts-library-panel">
                        <div class="search-box"><input type="text" class="form-input" placeholder="パーツを検索..." id="part-search-input"></div>
                        <div class="categories" id="categories"></div>
                    </div>
                    <div class="prompt-workspace">
                        <div class="current-prompt"><textarea class="prompt-input" id="prompt-input" placeholder="パーツを選択するか、直接入力してプロンプトを作成しましょう"></textarea></div>
                        <div class="translation-display">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="form-label" style="margin:0;">日本語翻訳</span>
                                <button class="btn btn-secondary btn-sm" id="auto-translate-btn">🌐 自動翻訳</button>
                            </div>
                            <textarea class="translation-input" id="translation-input" placeholder="追加したパーツの翻訳、または自動翻訳結果が表示されます"></textarea>
                        </div>
                        <div class="prompt-actions">
                            <button class="btn btn-danger" id="clear-prompt-btn">クリア</button>
                            <button class="btn btn-secondary" id="save-template-btn">テンプレートとして保存</button>
                            <button class="btn btn-primary" id="copy-prompt-btn">クリップボードにコピー</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="parts-tab" class="tab-content">
                <div class="parts-content">
                    <div class="parts-section category-mgmt">
                        <h3 class="section-title">カテゴリ管理</h3>
                        <div class="form-group"><input type="text" id="new-category-input" class="form-input" placeholder="新しいカテゴリ名"></div>
                        <button class="btn btn-secondary btn-sm" id="add-category-btn" style="margin-bottom: 16px;">カテゴリを追加</button>
                        <div class="category-scroll-area"><div id="category-unified-list"></div></div>
                    </div>
                    <div class="parts-section part-edit">
                        <h3 class="section-title" id="parts-form-title">パーツを追加</h3>
                        <input type="hidden" id="editing-part-id">
                        <button class="btn btn-primary btn-sm" id="submit-part-btn" style="width: 100%; margin-bottom: 16px;">パーツを追加</button>
                        <div class="form-group"><label class="form-label">プロンプト</label><textarea id="new-part-en" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">翻訳文 (オプション)</label><textarea id="new-part-ja" class="form-textarea" style="min-height: 60px;"></textarea></div>
                        <div class="form-group"><label class="form-label">カテゴリ</label><select id="new-part-category" class="form-select"></select></div>
                    </div>
                    <div class="parts-main">
                        <div class="search-box" style="padding: 0 0 16px 0;">
                            <input type="text" class="form-input" placeholder="登録済みパーツを検索..." id="parts-grid-filter-input">
                        </div>
                        <div id="parts-grid" style="overflow-y: auto; flex: 1; min-height: 400px;"></div>
                    </div>
                </div>
            </div>

            <div id="templates-tab" class="tab-content">
                <div class="templates-container">
                    <div class="template-edit-panel" id="template-edit-panel">
                        <div id="template-edit-form-container">
                            <div id="template-edit-form">
                                <input type="hidden" id="editing-template-id">
                                <button class="btn btn-primary" id="save-edited-template-btn" style="width:100%; margin-bottom: 16px;">テンプレートを作成</button>
                                <div class="form-group"><label class="form-label">タイトル</label><input type="text" id="template-title-input" class="form-input" placeholder="テンプレート名を入力"></div>
                                <div class="form-group"><label class="form-label">プロンプト</label><textarea id="template-prompt-input" class="form-textarea" style="min-height: 100px;"></textarea></div>
                                <div class="form-group"><label class="form-label">翻訳文（オプション）</label><textarea id="template-translation-input" class="form-textarea" style="min-height: 60px;"></textarea></div>
                                <div class="form-group"><label class="form-label">メモ（オプション）</label><textarea id="template-desc-input" class="form-textarea" style="min-height: 60px;"></textarea></div>
                                <div class="form-group">
                                    <label class="form-label">サムネイル（オプション）</label>
                                    <div class="thumbnail-preview" id="thumbnail-preview">クリックして画像を選択</div>
                                    <input type="file" id="thumbnail-upload" accept="image/*" style="display: none;" />
                                    <button class="btn btn-danger btn-sm" id="clear-thumbnail-btn" style="width:100%; margin-top: 8px;">画像をクリア</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="template-list-panel">
                        <div class="template-search-fixed">
                            <input type="text" class="form-input" placeholder="テンプレートを検索..." id="template-search-input">
                        </div>
                        <div class="template-list-scroll">
                            <div class="template-grid" id="template-grid"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-tab" class="tab-content">
                <div class="settings-section">
                    <div id="storage-warning" class="storage-warning" style="display: none;"></div>

                    <h3 class="section-title" style="margin-bottom:20px;">🌐 翻訳API</h3>
                    <div class="form-group">
                        <label class="form-label">自動翻訳 API URL</label>
                        <div class="api-settings-group" style="display:flex; gap:8px;">
                            <input type="text" id="translation-api-url-input" class="form-input" placeholder="例: https://libretranslate.de/translate" style="flex:1;">
                            <button class="btn btn-secondary btn-sm" id="test-api-btn">テスト</button>
                            <button class="btn btn-primary btn-sm" id="save-api-btn">登録</button>
                        </div>
                        <div id="api-test-result" style="margin-top: 8px; font-size: 12px;"></div>
                    </div>

                    <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);" />

                    <h3 class="section-title" style="margin-bottom:20px;">📁 データ切り替え（JSON）</h3>
                    <div class="json-management">
                        <div class="json-add-form">
                            <input type="text" id="new-json-name-input" class="form-input" placeholder="新しい設定名" style="flex: 1;" />
                            <button class="btn btn-primary btn-sm" id="save-current-json-btn">現在の設定を保存</button>
                        </div>
                        <div class="json-list" id="json-list"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" id="duplicate-json-btn" style="flex: 1;">複製</button>
                            <button class="btn btn-secondary btn-sm" id="rename-json-btn" style="flex: 1;">名前変更</button>
                        </div>
                    </div>

                    <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);" />

                    <h3 class="section-title" style="margin-bottom:20px;">💾 データ操作</h3>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <label class="export-btn import-label" style="flex: 1;">
                            <input type="file" accept=".json" id="import-data-input" style="display: none;" />📥 インポート
                        </label>
                        <button class="export-btn export-button" id="export-data-btn" style="flex: 1;">📤 エクスポート</button>
                    </div>
                    <button class="btn btn-secondary" id="edit-raw-data-btn" style="width: 100%; margin-bottom: 12px;">保存内容を編集 (JSON)</button>
                    <button class="export-btn reset-button" id="reset-data-btn" style="width: 100%;">⚠️ データ初期化</button>
                </div>
            </div>
        </div>
    </div>

    <div id="data-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="section-title">保存データの直接編集</h3>
                <button id="close-data-editor-btn" class="btn-sm btn-danger">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="data-editor-textarea" class="modal-textarea"></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancel-data-editor-btn" class="btn btn-secondary">キャンセル</button>
                <button id="save-data-from-editor-btn" class="btn btn-primary">変更を保存</button>
            </div>
        </div>
    </div>

    <div id="image-modal" class="image-modal">
        <img id="modal-image" src="" alt="拡大画像" />
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let state = {
            parts: [],
            templates: [],
            categories: ['スタイル', 'キャラクター', '背景', '品質向上', 'ネガティブプロンプト', 'カテゴリなし'],
            settings: { translationApiUrl: '' },
            currentPrompt: { en: '', ja: '' },
            categoryStates: {},
            clickedPartIdsInSession: new Set(),
            selectedPartIdsForBulkEdit: new Set(),
            editingPartId: null,
            editingTemplateId: null,
            isApiRegistered: false,
        };

        let jsonConfigs = [];
        let activeConfigIndex = 0;

        const defaultParts = [
            { id: generateId(), en: 'masterpiece, best quality', ja: '最高品質の作品', category: '品質向上' },
            { id: generateId(), en: 'ultra detailed, 8k resolution, photorealistic', ja: '超詳細、8K解像度、フォトリアル', category: '品質向上' },
            { id: generateId(), en: 'a beautiful young woman', ja: '美しい若い女性', category: 'キャラクター' },
        ];

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        const templatesTab = document.getElementById('templates-tab');
                        if (!templatesTab || !templatesTab.classList.contains('active')) {
                            DOMElements.saveTemplateBtn.click();
                        } else {
                            DOMElements.saveEditedTemplateBtn.click();
                        }
                        break;
                    case 'c':
                        const creationTab = document.getElementById('creation-tab');
                        if (creationTab && creationTab.classList.contains('active') && !e.target.matches('input, textarea')) {
                            e.preventDefault();
                            DOMElements.copyPromptBtn.click();
                        }
                        break;
                }
            }
            if (e.key === 'Escape') {
                DOMElements.imageModal.style.display = 'none';
                DOMElements.dataEditorModal.style.display = 'none';
            }
        });

        const DOMElements = {
            tabs: document.querySelectorAll('.nav-tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            promptInput: document.getElementById('prompt-input'),
            translationInput: document.getElementById('translation-input'),
            autoTranslateBtn: document.getElementById('auto-translate-btn'),
            categoriesContainer: document.getElementById('categories'),
            clearPromptBtn: document.getElementById('clear-prompt-btn'),
            saveTemplateBtn: document.getElementById('save-template-btn'),
            copyPromptBtn: document.getElementById('copy-prompt-btn'),
            partSearchInput: document.getElementById('part-search-input'),
            partsGrid: document.getElementById('parts-grid'),
            partsGridFilterInput: document.getElementById('parts-grid-filter-input'),
            partsFormTitle: document.getElementById('parts-form-title'),
            editingPartIdInput: document.getElementById('editing-part-id'),
            newPartEnInput: document.getElementById('new-part-en'),
            newPartJaInput: document.getElementById('new-part-ja'),
            newPartCategorySelect: document.getElementById('new-part-category'),
            submitPartBtn: document.getElementById('submit-part-btn'),
            categoryUnifiedList: document.getElementById('category-unified-list'),
            newCategoryInput: document.getElementById('new-category-input'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            templateGrid: document.getElementById('template-grid'),
            templateSearchInput: document.getElementById('template-search-input'),
            templateEditForm: document.getElementById('template-edit-form'),
            editingTemplateIdInput: document.getElementById('editing-template-id'),
            templateTitleInput: document.getElementById('template-title-input'),
            templateDescInput: document.getElementById('template-desc-input'),
            templatePromptInput: document.getElementById('template-prompt-input'),
            templateTranslationInput: document.getElementById('template-translation-input'),
            thumbnailPreview: document.getElementById('thumbnail-preview'),
            thumbnailUpload: document.getElementById('thumbnail-upload'),
            clearThumbnailBtn: document.getElementById('clear-thumbnail-btn'),
            saveEditedTemplateBtn: document.getElementById('save-edited-template-btn'),
            translationApiUrlInput: document.getElementById('translation-api-url-input'),
            testApiBtn: document.getElementById('test-api-btn'),
            saveApiBtn: document.getElementById('save-api-btn'),
            apiTestResult: document.getElementById('api-test-result'),
            importDataInput: document.getElementById('import-data-input'),
            exportDataBtn: document.getElementById('export-data-btn'),
            editRawDataBtn: document.getElementById('edit-raw-data-btn'),
            resetDataBtn: document.getElementById('reset-data-btn'),
            imageModal: document.getElementById('image-modal'),
            modalImage: document.getElementById('modal-image'),
            dataEditorModal: document.getElementById('data-editor-modal'),
            closeDataEditorBtn: document.getElementById('close-data-editor-btn'),
            dataEditorTextarea: document.getElementById('data-editor-textarea'),
            cancelDataEditorBtn: document.getElementById('cancel-data-editor-btn'),
            saveDataFromEditorBtn: document.getElementById('save-data-from-editor-btn'),
            storageWarning: document.getElementById('storage-warning'),
            newJsonNameInput: document.getElementById('new-json-name-input'),
            saveCurrentJsonBtn: document.getElementById('save-current-json-btn'),
            jsonList: document.getElementById('json-list'),
            duplicateJsonBtn: document.getElementById('duplicate-json-btn'),
            renameJsonBtn: document.getElementById('rename-json-btn'),
        };

        // Notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Tooltip
        let currentTooltip = null;
        function showTooltip(element, text, x, y) {
            hideTooltip();
            currentTooltip = document.createElement('div');
            currentTooltip.className = 'tooltip';
            currentTooltip.textContent = text;
            document.body.appendChild(currentTooltip);
            currentTooltip.style.left = Math.min(x, window.innerWidth - currentTooltip.offsetWidth - 10) + 'px';
            currentTooltip.style.top = Math.max(10, y - currentTooltip.offsetHeight - 5) + 'px';
            setTimeout(() => {
                if (currentTooltip) currentTooltip.classList.add('show');
            }, 50);
        }
        function hideTooltip() { if (currentTooltip) { currentTooltip.remove(); currentTooltip = null; } }

        // Storage usage watcher
        function checkStorageSize() {
            const data = localStorage.getItem('promptManagerData');
            if (data) {
                const sizeKB = (new Blob([data]).size / 1024).toFixed(1);
                const maxSizeKB = 5 * 1024; // 5MB
                const usagePercent = (sizeKB / maxSizeKB * 100).toFixed(1);
                if (sizeKB > maxSizeKB * 0.8) {
                    DOMElements.storageWarning.style.display = 'block';
                    DOMElements.storageWarning.textContent = `ストレージ使用量: ${sizeKB}KB (${usagePercent}%) - 容量不足の可能性があります`;
                    if (sizeKB > maxSizeKB * 0.9) {
                        showNotification('データ容量が上限に近づいています。不要なデータを削除してください。', 'warning');
                    }
                } else {
                    DOMElements.storageWarning.style.display = 'none';
                }
            }
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }

        function saveData() {
            // テンプレートのキー順を統一
            const orderedTemplates = state.templates.map(t => ({
                id: t.id,
                name: t.name,
                prompt: t.prompt,
                translation: t.translation,
                desc: t.desc,
                thumbnail: t.thumbnail
            }));
            const dataToSave = {
                settings: state.settings,
                categories: state.categories,
                parts: state.parts,
                templates: orderedTemplates,
            };
            localStorage.setItem('promptManagerData', JSON.stringify(dataToSave));
            localStorage.setItem('promptManagerCurrentPrompt', JSON.stringify(state.currentPrompt));
            checkStorageSize();
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('promptManagerData'));
            const currentPrompt = JSON.parse(localStorage.getItem('promptManagerCurrentPrompt'));
            if (data) {
                state.parts = data.parts || [];
                // テンプレートのキー順を統一
                state.templates = (data.templates || []).map(t => ({
                    id: t.id,
                    name: t.name,
                    prompt: t.prompt,
                    translation: t.translation,
                    desc: t.desc,
                    thumbnail: t.thumbnail
                }));
                state.categories = data.categories || ['スタイル', 'キャラクター', '背景', '品質向上', 'ネガティブプロンプト', 'カテゴリなし'];
                state.settings = data.settings || { translationApiUrl: '' };
            }
            if (state.parts.length === 0) state.parts = defaultParts;
            if (currentPrompt) state.currentPrompt = currentPrompt;
            DOMElements.translationApiUrlInput.value = state.settings.translationApiUrl;
            state.isApiRegistered = !!state.settings.translationApiUrl;
        }

        // JSON config management
        function loadJsonConfigs() {
            const saved = localStorage.getItem('jsonConfigs');
            if (saved) {
                jsonConfigs = JSON.parse(saved);
                // テンプレートのキー順を統一
                jsonConfigs.forEach(cfg => {
                    if (cfg.data && cfg.data.templates) {
                        cfg.data.templates = cfg.data.templates.map(t => ({
                            id: t.id,
                            name: t.name,
                            prompt: t.prompt,
                            translation: t.translation,
                            desc: t.desc,
                            thumbnail: t.thumbnail
                        }));
                    }
                });
            } else {
                // テンプレートのキー順を統一
                const orderedTemplates = state.templates.map(t => ({
                    id: t.id,
                    name: t.name,
                    prompt: t.prompt,
                    translation: t.translation,
                    desc: t.desc,
                    thumbnail: t.thumbnail
                }));
                jsonConfigs = [{
                    name: 'デフォルト',
                    data: {
                        settings: state.settings,
                        categories: state.categories,
                        parts: state.parts,
                        templates: orderedTemplates,
                    },
                }];
            }
            const activeIndex = localStorage.getItem('activeConfigIndex');
            if (activeIndex !== null) activeConfigIndex = parseInt(activeIndex);
            if (jsonConfigs[activeConfigIndex]) {
                const config = jsonConfigs[activeConfigIndex].data;
                state.settings = config.settings || { translationApiUrl: '' };
                state.categories = config.categories || ['スタイル', 'キャラクター', '背景', '品質向上', 'ネガティブプロンプト', 'カテゴリなし'];
                state.parts = config.parts || defaultParts;
                state.templates = config.templates || [];
                DOMElements.translationApiUrlInput.value = state.settings.translationApiUrl;
                state.isApiRegistered = !!state.settings.translationApiUrl;
            }
        }
        function saveJsonConfigs() {
            localStorage.setItem('jsonConfigs', JSON.stringify(jsonConfigs));
            localStorage.setItem('activeConfigIndex', activeConfigIndex.toString());
        }
        function updateCurrentConfig() {
            if (jsonConfigs[activeConfigIndex]) {
                jsonConfigs[activeConfigIndex].data = {
                    settings: state.settings,
                    categories: state.categories,
                    parts: state.parts,
                    templates: state.templates,
                };
                saveJsonConfigs();
            }
        }
        function renderJsonConfigs() {
            DOMElements.jsonList.innerHTML = jsonConfigs.map((config, index) => `
                <div class="json-item ${index === activeConfigIndex ? 'active' : ''}" data-index="${index}" draggable="true">
                    <span class="drag-handle" title="ドラッグで並び替え">&#9776;</span>
                    <span class="json-item-name">${config.name}</span>
                    <div class="json-item-actions">
                        <button class="btn btn-secondary btn-sm" data-action="switch" data-index="${index}">切替</button>
                        <button class="btn btn-danger btn-sm" data-action="delete" data-index="${index}" ${jsonConfigs.length === 1 ? 'disabled' : ''}>削除</button>
                    </div>
                </div>
            `).join('');
            initializeJsonConfigsDragAndDrop();
        function initializeJsonConfigsDragAndDrop() {
            const jsonItems = DOMElements.jsonList.querySelectorAll('.json-item');
            let draggedElement = null;
            jsonItems.forEach((item) => {
                item.addEventListener('dragstart', () => { draggedElement = item; item.classList.add('dragging'); });
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); draggedElement = null; });
                item.addEventListener('dragover', (e) => e.preventDefault());
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(item.dataset.index);
                        const [draggedConfig] = jsonConfigs.splice(draggedIndex, 1);
                        jsonConfigs.splice(targetIndex, 0, draggedConfig);
                        saveJsonConfigs();
                        renderJsonConfigs();
                    }
                });
            });
        }
        }

        async function resizeImage(file, maxSize = 400) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;
                        if (width > height) {
                            if (width > maxSize) { height = (height * maxSize) / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderAll() {
            renderCategoriesAndParts();
            renderPartsGrid();
            renderCategoryManagement();
            updatePartCategorySelect();
            renderTemplates();
            updateBulkEditUI();
            renderJsonConfigs();
            DOMElements.promptInput.value = state.currentPrompt.en;
            DOMElements.translationInput.value = state.currentPrompt.ja;
        }

        function renderCategoriesAndParts() {
            const query = DOMElements.partSearchInput.value.toLowerCase();
            DOMElements.categoriesContainer.innerHTML = state.categories.map((categoryName) => {
                const isExpanded = state.categoryStates[categoryName] || false;
                const categoryParts = state.parts.filter(
                    (p) => p.category === categoryName && (p.en.toLowerCase().includes(query) || (p.ja && p.ja.toLowerCase().includes(query)))
                );
                const allCategoryParts = state.parts.filter((p) => p.category === categoryName);
                if (categoryParts.length === 0 && query) return '';
                const toggleIcon = isExpanded ? '▽' : '▶';
                const partCount = allCategoryParts.length;
                return `
                    <div class="category ${isExpanded ? 'expanded' : ''}">
                        <div class="category-header" data-category-name="${categoryName}">
                            <span class="category-toggle">${toggleIcon}</span>
                            <span>${categoryName} <span style="color: #9ca3af; font-weight: normal;">(${partCount})</span></span>
                        </div>
                        <div class="category-content">
                            ${categoryParts
                                .map((part) => {
                                    const isSelected = state.clickedPartIdsInSession.has(part.id);
                                    return `
                                        <div class="prompt-part" data-id="${part.id}" data-en="${part.en}" data-ja="${part.ja || ''}" title="${part.en}${part.ja ? ' / ' + part.ja : ''}">
                                            <div class="prompt-part-main long-text-handler">
                                                <div class="prompt-en">${part.en}</div>
                                                <div class="prompt-ja">${part.ja || '&nbsp;'}</div>
                                            </div>
                                            <button class="add-btn ${isSelected ? 'selected' : ''}" tabindex="-1">
                                                ${isSelected ? '<svg class="icon-minus" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="10" height="2" rx="1" fill="yellow"/></svg>' : '+'}
                                            </button>
                                        </div>`;
                                })
                                .join('')}
                        </div>
                    </div>`;
            }).join('');
        }

        function renderPartsGrid(query = '') {
            const lowerQuery = query.toLowerCase();
            const filteredParts = state.parts.filter((p) => p.en.toLowerCase().includes(lowerQuery) || (p.ja && p.ja.toLowerCase().includes(lowerQuery)));
            DOMElements.partsGrid.innerHTML = filteredParts
                .map((part, index) => {
                    const isSelected = state.selectedPartIdsForBulkEdit.has(part.id);
                    const isEditing = state.editingPartId === part.id;
                    return `
                    <div class="card" data-index="${index}" draggable="true">
                        <input type="checkbox" class="bulk-part-checkbox" data-id="${part.id}" ${isSelected ? 'checked' : ''} style="margin-top: 4px;" />
                        <div class="long-text-handler" style="flex:1;" data-full-text="${part.en}${part.ja ? ' / ' + part.ja : ''}">
                            <div style="font-weight: 500;">${part.en.length > 50 ? part.en.substring(0, 50) + '...' : part.en}</div>
                            <div style="font-size: 12px; color: #666;">${part.ja ? (part.ja.length > 30 ? part.ja.substring(0, 30) + '...' : part.ja) : '翻訳文なし'}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0;">
                            <span style="font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px;">${part.category}</span>
                            <div class="card-actions" style="margin:0; border:none; padding:0;">
                                <button class="btn btn-secondary btn-sm ${isEditing ? 'active' : ''}" data-action="edit-part" data-id="${part.id}">編集</button>
                                <button class="btn btn-danger btn-sm" data-action="delete-part" data-id="${part.id}">削除</button>
                            </div>
                        </div>
                    </div>`;
                })
                .join('');
            initializePartsDragAndDrop();
            setupTooltips();
        }

        function setupTooltips() {
            document.querySelectorAll('[data-full-text]').forEach((element) => {
                element.addEventListener('mouseenter', (e) => {
                    let fullText = e.target.dataset.fullText;
                    if (typeof fullText === 'undefined' && e.target.closest('[data-full-text]')) {
                        fullText = e.target.closest('[data-full-text]').dataset.fullText;
                    }
                    // null, undefined, 空文字列, 'null', 'undefined' の場合は何もしない
                    if (
                        fullText !== undefined &&
                        fullText !== null &&
                        typeof fullText === 'string' &&
                        fullText.trim() !== '' &&
                        fullText.trim().toLowerCase() !== 'null' &&
                        fullText.trim().toLowerCase() !== 'undefined'
                    ) {
                        showTooltip(e.target, fullText, e.pageX, e.pageY);
                    }
                });
                element.addEventListener('mouseleave', hideTooltip);
                element.addEventListener('mousemove', (e) => {
                    if (currentTooltip) {
                        currentTooltip.style.left = Math.min(e.pageX, window.innerWidth - currentTooltip.offsetWidth - 10) + 'px';
                        currentTooltip.style.top = Math.max(10, e.pageY - currentTooltip.offsetHeight - 5) + 'px';
                    }
                });
            });
        }

        function updateBulkEditUI() {
            const hasBulkSelection = state.selectedPartIdsForBulkEdit.size > 0;
            DOMElements.newPartEnInput.disabled = hasBulkSelection;
            DOMElements.newPartJaInput.disabled = hasBulkSelection;
            if (hasBulkSelection) {
                DOMElements.partsFormTitle.textContent = 'カテゴリ変更';
                DOMElements.submitPartBtn.textContent = 'カテゴリを変更';
                DOMElements.newPartCategorySelect.disabled = false;
            } else {
                DOMElements.partsFormTitle.textContent = state.editingPartId ? 'パーツを編集' : 'パーツを追加';
                DOMElements.submitPartBtn.textContent = state.editingPartId ? 'パーツを更新' : 'パーツを追加';
                DOMElements.newPartCategorySelect.disabled = false;
            }
        }

        function renderCategoryManagement() {
            DOMElements.categoryUnifiedList.innerHTML = state.categories
                .map((cat, index) => {
                    const partCount = state.parts.filter((p) => p.category === cat).length;
                    return `
                    <div class="category-reorder-item" draggable="true" data-index="${index}">
                        <span class="drag-handle">☰</span>
                        <span class="category-name">${cat} <span style=\"color: #9ca3af; font-weight: normal;\">(${partCount})</span></span>
                        <button class="btn btn-danger btn-sm" data-action="delete-cat" data-category="${cat}">削除</button>
                    </div>`;
                })
                .join('');
            initializeCategoryDragAndDrop();
        }

        function initializeTemplateDragAndDrop() {
            const templateCards = DOMElements.templateGrid.querySelectorAll('.template-card');
            let draggedElement = null;
            templateCards.forEach((card) => {
                card.addEventListener('dragstart', () => { draggedElement = card; card.classList.add('dragging'); });
                card.addEventListener('dragend', () => { card.classList.remove('dragging'); draggedElement = null; });
                card.addEventListener('dragover', (e) => e.preventDefault());
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== card) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(card.dataset.index);
                        const [draggedTemplate] = state.templates.splice(draggedIndex, 1);
                        state.templates.splice(targetIndex, 0, draggedTemplate);
                        saveData();
                        updateCurrentConfig();
                        renderTemplates(DOMElements.templateSearchInput.value);
                    }
                });
            });
        }

        function initializePartsDragAndDrop() {
            const partCards = DOMElements.partsGrid.querySelectorAll('.card');
            let draggedElement = null;
            partCards.forEach((card, index) => {
                card.setAttribute('data-index', index);
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', () => { draggedElement = card; card.classList.add('dragging'); });
                card.addEventListener('dragend', () => { card.classList.remove('dragging'); draggedElement = null; });
                card.addEventListener('dragover', (e) => e.preventDefault());
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== card) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(card.dataset.index);
                        const [draggedPart] = state.parts.splice(draggedIndex, 1);
                        state.parts.splice(targetIndex, 0, draggedPart);
                        saveData();
                        updateCurrentConfig();
                        renderPartsGrid(DOMElements.partsGridFilterInput.value);
                    }
                });
            });
        }

        function setupImageModal() {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('template-thumbnail')) {
                    e.stopPropagation();
                    const fullImageSrc = e.target.dataset.fullImage || e.target.src;
                    DOMElements.modalImage.src = fullImageSrc;
                    DOMElements.imageModal.style.display = 'flex';
                }
            });
            DOMElements.imageModal.addEventListener('click', () => { DOMElements.imageModal.style.display = 'none'; });
        }

        function initializeCategoryDragAndDrop() {
            const categoryItems = DOMElements.categoryUnifiedList.querySelectorAll('.category-reorder-item');
            let draggedElement = null;
            categoryItems.forEach((item) => {
                item.addEventListener('dragstart', () => { draggedElement = item; item.classList.add('dragging'); });
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); draggedElement = null; });
                item.addEventListener('dragover', (e) => e.preventDefault());
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(item.dataset.index);
                        const [draggedCategory] = state.categories.splice(draggedIndex, 1);
                        state.categories.splice(targetIndex, 0, draggedCategory);
                        saveData();
                        updateCurrentConfig();
                        renderCategoryManagement();
                        updatePartCategorySelect();
                    }
                });
            });
        }

        function updatePartCategorySelect() {
            DOMElements.newPartCategorySelect.innerHTML = state.categories.map((cat) => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderTemplates(query = '') {
            const lowerQuery = query.toLowerCase();
            const filteredTemplates = state.templates.filter(
                (t) => (t.name && t.name.toLowerCase().includes(lowerQuery)) || (t.desc && t.desc.toLowerCase().includes(lowerQuery)) || (t.prompt && t.prompt.toLowerCase().includes(lowerQuery))
            );
            DOMElements.templateGrid.innerHTML = filteredTemplates
                .map((template, index) => `
                <div class="template-card" data-id="${template.id}" data-index="${index}" draggable="true">
                    <div class="template-card-header">
                        ${template.thumbnail
                            ? `<img src="${template.thumbnail}" style="width:60px; height:60px; object-fit:cover; border-radius:4px; cursor:pointer; flex-shrink: 0;" class="template-thumbnail" data-full-image="${template.thumbnail}">`
                            : `<div style=\"width:60px; height:60px; background:#eee; border-radius:4px; flex-shrink:0;\"></div>`}
                        <input type="text" class="template-card-title" value="${template.name || 'タイトル未設定'}" data-id="${template.id}" placeholder="テンプレート名">
                        <div class="template-card-actions">
                            <button class="btn btn-secondary btn-sm" data-action="apply-template" data-id="${template.id}">適用</button>
                            <button class="btn btn-secondary btn-sm ${state.editingTemplateId === template.id ? 'active' : ''}" data-action="edit-template" data-id="${template.id}">編集</button>
                            <button class="btn btn-danger btn-sm" data-action="delete-template" data-id="${template.id}">削除</button>
                        </div>
                    </div>
                    <div class="template-card-details" data-full-text="${template.prompt || 'プロンプトなし'} | ${template.translation || '翻訳文なし'} | ${template.desc || 'メモなし'}">
                        <p><strong>プロンプト:</strong> ${template.prompt ? (template.prompt.length > 50 ? template.prompt.substring(0, 50) + '...' : template.prompt) : 'なし'}</p>
                        <p><strong>翻訳文:</strong> ${template.translation ? (template.translation.length > 30 ? template.translation.substring(0, 30) + '...' : template.translation) : 'なし'}</p>
                        <p><strong>メモ:</strong> ${template.desc ? (template.desc.length > 40 ? template.desc.substring(0, 40) + '...' : template.desc) : 'なし'}</p>
                    </div>
                </div>`)
                .join('');
            initializeTemplateDragAndDrop();
            setupTooltips();
        }

        function setupThumbnailHandlers() {
            DOMElements.thumbnailPreview.addEventListener('click', () => { DOMElements.thumbnailUpload.click(); });
            DOMElements.thumbnailUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    try {
                        const resizedImage = await resizeImage(file);
                        DOMElements.thumbnailPreview.style.backgroundImage = `url(${resizedImage})`;
                        DOMElements.thumbnailPreview.classList.add('has-image');
                        DOMElements.thumbnailPreview.textContent = '画像を変更するにはクリック';
                        const templateId = DOMElements.editingTemplateIdInput.value;
                        if (templateId) {
                            const template = state.templates.find((t) => t.id === templateId);
                            if (template) {
                                template.thumbnail = resizedImage;
                                saveData(); updateCurrentConfig(); renderTemplates(DOMElements.templateSearchInput.value);
                            }
                        }
                    } catch (error) {
                        showNotification('画像の処理に失敗しました: ' + error.message, 'error');
                    }
                }
            });
            DOMElements.clearThumbnailBtn.addEventListener('click', () => {
                DOMElements.thumbnailPreview.style.backgroundImage = '';
                DOMElements.thumbnailPreview.classList.remove('has-image');
                DOMElements.thumbnailPreview.textContent = 'クリックして画像を選択';
                const templateId = DOMElements.editingTemplateIdInput.value;
                if (templateId) {
                    const template = state.templates.find((t) => t.id === templateId);
                    if (template) { template.thumbnail = null; saveData(); updateCurrentConfig(); renderTemplates(DOMElements.templateSearchInput.value); }
                }
            });
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => { DOMElements.thumbnailPreview.addEventListener(eventName, preventDefaults, false); });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach((eventName) => { DOMElements.thumbnailPreview.addEventListener(eventName, () => { DOMElements.thumbnailPreview.style.borderColor = 'var(--primary-color)'; }, false); });
            ['dragleave', 'drop'].forEach((eventName) => { DOMElements.thumbnailPreview.addEventListener(eventName, () => { DOMElements.thumbnailPreview.style.borderColor = 'var(--border-color)'; }, false); });
            DOMElements.thumbnailPreview.addEventListener('drop', async (e) => {
                const dt = e.dataTransfer; const files = dt.files; if (files.length > 0) {
                    const file = files[0]; if (file.type.startsWith('image/')) {
                        try {
                            const resizedImage = await resizeImage(file);
                            DOMElements.thumbnailPreview.style.backgroundImage = `url(${resizedImage})`;
                            DOMElements.thumbnailPreview.classList.add('has-image');
                            DOMElements.thumbnailPreview.textContent = '画像を変更するにはクリック';
                            const templateId = DOMElements.editingTemplateIdInput.value;
                            if (templateId) {
                                const template = state.templates.find((t) => t.id === templateId);
                                if (template) { template.thumbnail = resizedImage; saveData(); updateCurrentConfig(); renderTemplates(DOMElements.templateSearchInput.value); }
                            }
                        } catch (error) { showNotification('画像の処理に失敗しました: ' + error.message, 'error'); }
                    }
                }
            }, false);
        }

        async function testTranslationAPI(apiUrl) {
            const testText = 'API registration completed successfully.';
            try {
                let requestBody, headers = { 'Content-Type': 'application/json' };
                if (apiUrl.includes('libretranslate')) {
                    requestBody = JSON.stringify({ q: testText, source: 'en', target: 'ja', format: 'text' });
                } else {
                    requestBody = JSON.stringify({ text: testText });
                }
                const response = await fetch(apiUrl, { method: 'POST', body: requestBody, headers });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`HTTP ${response.status}: ${errorText}`); }
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                let translation;
                if (apiUrl.includes('libretranslate')) translation = result.translatedText; else translation = result.translation || result.translatedText || result.result || result;
                if (typeof translation === 'string') return { success: true, translation };
                throw new Error('翻訳結果が文字列ではありません: ' + JSON.stringify(result));
            } catch (error) { return { success: false, error: error.message }; }
        }

        // Tabs
        DOMElements.tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
                DOMElements.tabs.forEach((t) => t.classList.remove('active'));
                tab.classList.add('active');
                DOMElements.tabContents.forEach((c) => c.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                if (tab.dataset.tab === 'creation') { state.categoryStates = {}; renderCategoriesAndParts(); }
            });
        });

        // Category Panel
        DOMElements.categoriesContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.category-header');
            if (header) {
                const categoryName = header.dataset.categoryName;
                state.categoryStates[categoryName] = !state.categoryStates[categoryName];
                renderCategoriesAndParts();
                return;
            }
            const partCard = e.target.closest('.prompt-part');
            if (partCard) {
                state.clickedPartIdsInSession.add(partCard.dataset.id);
                const enText = partCard.dataset.en;
                const currentVal = DOMElements.promptInput.value.trim();
                if (currentVal && !currentVal.endsWith(',')) { DOMElements.promptInput.value += ', '; }
                DOMElements.promptInput.value += enText;
                DOMElements.promptInput.dispatchEvent(new Event('input'));
                renderCategoriesAndParts();
            }
        });

        // API settings
        DOMElements.saveApiBtn.addEventListener('click', () => {
            const apiUrl = DOMElements.translationApiUrlInput.value.trim();
            if (!apiUrl) { DOMElements.apiTestResult.innerHTML = '<span style="color: red;">URLを入力してください。</span>'; return; }
            state.settings.translationApiUrl = apiUrl;
            state.isApiRegistered = true;
            saveData(); updateCurrentConfig();
            DOMElements.apiTestResult.innerHTML = '<span style="color: green;">API URLが登録されました。</span>';
        });
        DOMElements.testApiBtn.addEventListener('click', async () => {
            const apiUrl = DOMElements.translationApiUrlInput.value.trim();
            if (!apiUrl) { DOMElements.apiTestResult.innerHTML = '<span style="color: red;">URLを入力してください。</span>'; return; }
            DOMElements.apiTestResult.innerHTML = '<span style="color: blue;">テスト中...</span>';
            const result = await testTranslationAPI(apiUrl);
            if (result.success) { DOMElements.apiTestResult.innerHTML = `<span style=\"color: green;\">成功: ${result.translation}</span>`; }
            else { DOMElements.apiTestResult.innerHTML = `<span style=\"color: red;\">エラー: ${result.error}</span>`; }
        });
        DOMElements.autoTranslateBtn.addEventListener('click', async () => {
            const apiUrl = state.settings.translationApiUrl;
            const textToTranslate = DOMElements.promptInput.value;
            if (!state.isApiRegistered || !apiUrl) { showNotification('設定画面でAPI URLを登録してください。', 'error'); return; }
            if (!textToTranslate) { showNotification('翻訳するプロンプトがありません。', 'error'); return; }
            try {
                DOMElements.autoTranslateBtn.textContent = '翻訳中...';
                DOMElements.autoTranslateBtn.disabled = true;
                let requestBody;
                if (apiUrl.includes('libretranslate')) {
                    requestBody = JSON.stringify({ q: textToTranslate, source: 'en', target: 'ja', format: 'text' });
                } else { requestBody = JSON.stringify({ text: textToTranslate }); }
                const response = await fetch(apiUrl, { method: 'POST', body: requestBody, headers: { 'Content-Type': 'application/json' } });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`HTTP ${response.status}: ${errorText}`); }
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                let translation = apiUrl.includes('libretranslate') ? result.translatedText : (result.translation || result.translatedText || result.result || result);
                if (typeof translation === 'string') {
                    DOMElements.translationInput.value = translation; state.currentPrompt.ja = translation; saveData(); showNotification('翻訳が完了しました。');
                } else { throw new Error('翻訳結果が文字列ではありません'); }
            } catch (error) {
                if (error.name === 'TypeError' && (error.message || '').includes('fetch')) showNotification('ネットワークエラー: CORS制限またはURL無効', 'error');
                else showNotification(`翻訳に失敗しました: ${error.message}`, 'error');
            } finally {
                DOMElements.autoTranslateBtn.textContent = '🌐 自動翻訳';
                DOMElements.autoTranslateBtn.disabled = false;
            }
        });

        // Prompt and translation inputs
        function updatePartsBasedTranslation() {
            const promptText = DOMElements.promptInput.value;
            if (!promptText.trim()) { DOMElements.translationInput.value = ''; state.currentPrompt.ja = ''; return; }
            const promptParts = promptText.split(/[ ,、]+/).map((p) => p.trim()).filter(Boolean);
            const translations = []; const usedPartIds = new Set();
            promptParts.forEach((enPart) => {
                let foundPart = state.parts.find((p) => p.en === enPart && !usedPartIds.has(p.id));
                if (!foundPart) {
                    const matchingParts = state.parts
                        .filter((p) => !usedPartIds.has(p.id) && (p.en.includes(enPart) || enPart.includes(p.en)))
                        .sort((a, b) => b.en.length - a.en.length);
                    if (matchingParts.length > 0) foundPart = matchingParts[0];
                }
                if (foundPart && foundPart.ja) { translations.push(foundPart.ja); usedPartIds.add(foundPart.id); }
            });
            if (translations.length > 0) { const newTranslation = translations.join('、'); DOMElements.translationInput.value = newTranslation; state.currentPrompt.ja = newTranslation; }
        }
        DOMElements.promptInput.addEventListener('input', () => { state.currentPrompt.en = DOMElements.promptInput.value; updatePartsBasedTranslation(); saveData(); });
        DOMElements.promptInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const currentValue = DOMElements.promptInput.value.trim();
                if (currentValue && !currentValue.endsWith(',')) { DOMElements.promptInput.value += ', '; }
                DOMElements.promptInput.setSelectionRange(DOMElements.promptInput.value.length, DOMElements.promptInput.value.length);
                DOMElements.promptInput.dispatchEvent(new Event('input'));
            }
        });
        DOMElements.translationInput.addEventListener('input', () => { state.currentPrompt.ja = DOMElements.translationInput.value; saveData(); });
        DOMElements.clearPromptBtn.addEventListener('click', () => { state.currentPrompt = { en: '', ja: '' }; state.clickedPartIdsInSession.clear(); DOMElements.promptInput.value = ''; DOMElements.translationInput.value = ''; saveData(); renderCategoriesAndParts(); });
        DOMElements.copyPromptBtn.addEventListener('click', () => { navigator.clipboard.writeText(DOMElements.promptInput.value).then(() => { const originalText = DOMElements.copyPromptBtn.textContent; DOMElements.copyPromptBtn.textContent = 'コピー!'; setTimeout(() => (DOMElements.copyPromptBtn.textContent = originalText), 1500); }); });
        DOMElements.saveTemplateBtn.addEventListener('click', () => {
            if (!DOMElements.promptInput.value) { showNotification('プロンプトがありません。', 'error'); return; }
            state.templates.unshift({ id: generateId(), name: '新しいテンプレート', desc: '', prompt: DOMElements.promptInput.value, translation: DOMElements.translationInput.value, thumbnail: null });
            saveData(); updateCurrentConfig(); renderTemplates(); showNotification('テンプレートを保存しました。');
        });

        // Search inputs
        DOMElements.partSearchInput.addEventListener('input', renderCategoriesAndParts);
        DOMElements.partsGridFilterInput.addEventListener('input', (e) => { renderPartsGrid(e.target.value); });
        DOMElements.templateSearchInput.addEventListener('input', (e) => { renderTemplates(e.target.value); });

        // Parts grid selection for bulk edit
        DOMElements.partsGrid.addEventListener('change', (e) => {
            if (e.target.classList.contains('bulk-part-checkbox')) {
                const partId = e.target.dataset.id;
                if (e.target.checked) state.selectedPartIdsForBulkEdit.add(partId); else state.selectedPartIdsForBulkEdit.delete(partId);
                updateBulkEditUI();
            }
        });

        // Add category
        DOMElements.addCategoryBtn.addEventListener('click', () => {
            const newCat = DOMElements.newCategoryInput.value.trim();
            if (newCat && !state.categories.includes(newCat)) {
                state.categories.unshift(newCat);
                DOMElements.newCategoryInput.value = '';
                saveData(); updateCurrentConfig(); renderCategoryManagement(); updatePartCategorySelect();
            }
        });

        // Add / Update part or bulk category change
        DOMElements.submitPartBtn.addEventListener('click', () => {
            const hasBulkSelection = state.selectedPartIdsForBulkEdit.size > 0;
            if (hasBulkSelection) {
                const newCategory = DOMElements.newPartCategorySelect.value;
                state.selectedPartIdsForBulkEdit.forEach((partId) => { const part = state.parts.find((p) => p.id === partId); if (part) part.category = newCategory; });
                state.selectedPartIdsForBulkEdit.clear();
                updateBulkEditUI();
                saveData(); updateCurrentConfig(); renderAll();
                showNotification('カテゴリを変更しました。');
            } else {
                const en = DOMElements.newPartEnInput.value.trim();
                const ja = DOMElements.newPartJaInput.value.trim();
                const category = DOMElements.newPartCategorySelect.value;
                if (!en) { showNotification('プロンプトを入力してください。', 'error'); return; }
                const editingId = DOMElements.editingPartIdInput.value;
                if (editingId) {
                    const part = state.parts.find((p) => p.id === editingId);
                    if (part) { part.en = en; part.ja = ja; part.category = category; }
                    showNotification('パーツを更新しました。');
                } else {
                    state.parts.push({ id: generateId(), en, ja, category });
                    showNotification('パーツを追加しました。');
                }
                // reset form
                DOMElements.editingPartIdInput.value = '';
                DOMElements.newPartEnInput.value = '';
                DOMElements.newPartJaInput.value = '';
                state.editingPartId = null;
                updateBulkEditUI();
                saveData(); updateCurrentConfig(); renderAll();
            }
        });

        // Export / Import
        DOMElements.exportDataBtn.addEventListener('click', () => {
            const data = localStorage.getItem('promptManagerData') || JSON.stringify({});
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'prompt-manager-data.json'; a.click(); URL.revokeObjectURL(url);
            showNotification('データをエクスポートしました。');
        });
        DOMElements.importDataInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (confirm('現在のすべてのデータが上書きされます。よろしいですか？')) {
                        localStorage.setItem('promptManagerData', JSON.stringify(data));
                        location.reload();
                    }
                } catch (error) { showNotification('ファイルの読み込みに失敗しました。', 'error'); }
            };
            reader.readAsText(file);
        });

        // Parts grid action buttons
        DOMElements.partsGrid.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action]'); if (!target) return; const id = target.dataset.id;
            if (target.dataset.action === 'edit-part') {
                state.selectedPartIdsForBulkEdit.clear();
                // すでに編集中ならキャンセル（解除）
                if (state.editingPartId === id) {
                    DOMElements.editingPartIdInput.value = '';
                    DOMElements.newPartEnInput.value = '';
                    DOMElements.newPartJaInput.value = '';
                    state.editingPartId = null;
                    updateBulkEditUI();
                    renderPartsGrid(DOMElements.partsGridFilterInput.value);
                    return;
                }
                const part = state.parts.find((p) => p.id === id);
                if (!part) return;
                DOMElements.editingPartIdInput.value = id; state.editingPartId = id;
                DOMElements.newPartEnInput.value = part.en; DOMElements.newPartJaInput.value = part.ja || ''; DOMElements.newPartCategorySelect.value = part.category;
                updateBulkEditUI(); renderPartsGrid(DOMElements.partsGridFilterInput.value);
            } else if (target.dataset.action === 'delete-part') {
                state.parts = state.parts.filter((p) => p.id !== id);
                saveData(); updateCurrentConfig(); renderAll(); showNotification('パーツを削除しました。');
            }
        });

        // Category management actions
        DOMElements.categoryUnifiedList.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action]'); if (!target) return;
            if (target.dataset.action === 'delete-cat') {
                const categoryToDelete = target.dataset.category;
                if (confirm(`カテゴリ「${categoryToDelete}」を削除しますか？\n※このカテゴリのパーツは「カテゴリなし」カテゴリに移動されます。`)) {
                    state.parts.forEach((part) => { if (part.category === categoryToDelete) part.category = 'カテゴリなし'; });
                    state.categories = state.categories.filter((cat) => cat !== categoryToDelete);
                    saveData(); updateCurrentConfig(); renderAll(); showNotification('カテゴリを削除しました。');
                }
            }
        });

        // Templates actions
        DOMElements.templateGrid.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action]'); if (!target) return; const id = target.dataset.id;
            if (target.dataset.action === 'edit-template') {
                // すでに編集中ならキャンセル（解除）
                if (state.editingTemplateId === id) {
                    state.editingTemplateId = null;
                    DOMElements.saveEditedTemplateBtn.textContent = 'テンプレートを作成';
                    DOMElements.editingTemplateIdInput.value = '';
                    DOMElements.templateTitleInput.value = '';
                    DOMElements.templateDescInput.value = '';
                    DOMElements.templatePromptInput.value = '';
                    DOMElements.templateTranslationInput.value = '';
                    DOMElements.thumbnailPreview.style.backgroundImage = '';
                    DOMElements.thumbnailPreview.classList.remove('has-image');
                    DOMElements.thumbnailPreview.textContent = 'クリックして画像を選択';
                    renderTemplates(DOMElements.templateSearchInput.value);
                    return;
                }
                const template = state.templates.find((t) => t.id === id); if (!template) return;
                state.editingTemplateId = id;
                DOMElements.saveEditedTemplateBtn.textContent = 'テンプレートを更新';
                DOMElements.editingTemplateIdInput.value = id;
                DOMElements.templateTitleInput.value = template.name || '';
                DOMElements.templatePromptInput.value = template.prompt || '';
                DOMElements.templateTranslationInput.value = template.translation || '';
                DOMElements.templateDescInput.value = template.desc || '';
                if (template.thumbnail) { DOMElements.thumbnailPreview.style.backgroundImage = `url(${template.thumbnail})`; DOMElements.thumbnailPreview.classList.add('has-image'); DOMElements.thumbnailPreview.textContent = '画像を変更するにはクリック'; }
                else { DOMElements.thumbnailPreview.style.backgroundImage = ''; DOMElements.thumbnailPreview.classList.remove('has-image'); DOMElements.thumbnailPreview.textContent = 'クリックして画像を選択'; }
                renderTemplates(DOMElements.templateSearchInput.value);
            } else if (target.dataset.action === 'apply-template') {
                const template = state.templates.find((t) => t.id === id); if (!template) return;
                state.currentPrompt.en = template.prompt || '';
                state.currentPrompt.ja = template.translation || '';
                DOMElements.promptInput.value = state.currentPrompt.en;
                DOMElements.translationInput.value = state.currentPrompt.ja;
                saveData(); showNotification('テンプレートを適用しました。');
                document.querySelector('[data-tab="creation"]').click();
            } else if (target.dataset.action === 'delete-template') {
                state.templates = state.templates.filter((t) => t.id !== id);
                if (state.editingTemplateId === id) {
                    state.editingTemplateId = null;
                    DOMElements.saveEditedTemplateBtn.textContent = 'テンプレートを作成';
                    DOMElements.editingTemplateIdInput.value = '';
                    DOMElements.templateTitleInput.value = '';
                    DOMElements.templateDescInput.value = '';
                    DOMElements.templatePromptInput.value = '';
                    DOMElements.templateTranslationInput.value = '';
                    DOMElements.thumbnailPreview.style.backgroundImage = '';
                    DOMElements.thumbnailPreview.classList.remove('has-image');
                    DOMElements.thumbnailPreview.textContent = 'クリックして画像を選択';
                }
                saveData(); updateCurrentConfig(); renderTemplates(); showNotification('テンプレートを削除しました。');
            }
        });
        DOMElements.templateGrid.addEventListener('input', (e) => {
            if (e.target.classList.contains('template-card-title')) {
                const id = e.target.dataset.id; const template = state.templates.find((t) => t.id === id);
                if (template) { template.name = e.target.value; saveData(); updateCurrentConfig(); }
            }
        });
        DOMElements.saveEditedTemplateBtn.addEventListener('click', () => {
            const id = DOMElements.editingTemplateIdInput.value;
            const title = DOMElements.templateTitleInput.value.trim();
            const desc = DOMElements.templateDescInput.value;
            const prompt = DOMElements.templatePromptInput.value;
            const translation = DOMElements.templateTranslationInput.value;
            if (!title) { showNotification('タイトルを入力してください。', 'error'); return; }
            if (id) {
                const template = state.templates.find((t) => t.id === id);
                if (template) { template.name = title; template.desc = desc; template.prompt = prompt; template.translation = translation; showNotification('テンプレートを更新しました。'); }
            } else {
                state.templates.unshift({ id: generateId(), name: title, desc, prompt, translation, thumbnail: null });
                showNotification('テンプレートを作成しました。');
            }
            state.editingTemplateId = null;
            saveData(); updateCurrentConfig(); renderTemplates();
            // reset form
            DOMElements.saveEditedTemplateBtn.textContent = 'テンプレートを作成';
            DOMElements.editingTemplateIdInput.value = '';
            DOMElements.templateTitleInput.value = '';
            DOMElements.templatePromptInput.value = '';
            DOMElements.templateTranslationInput.value = '';
            DOMElements.templateDescInput.value = '';
            DOMElements.thumbnailPreview.style.backgroundImage = '';
            DOMElements.thumbnailPreview.classList.remove('has-image');
            DOMElements.thumbnailPreview.textContent = 'クリックして画像を選択';
        });

        // JSON settings buttons
        DOMElements.saveCurrentJsonBtn.addEventListener('click', () => {
            const name = DOMElements.newJsonNameInput.value.trim();
            if (!name) { showNotification('設定名を入力してください。', 'error'); return; }
            if (jsonConfigs.find((c) => c.name === name)) { showNotification('同じ名前の設定が既に存在します。', 'error'); return; }
            // テンプレートのキー順を統一
            const orderedTemplates = state.templates.map(t => ({
                id: t.id,
                name: t.name,
                prompt: t.prompt,
                translation: t.translation,
                desc: t.desc,
                thumbnail: t.thumbnail
            }));
            jsonConfigs.push({ name, data: { settings: state.settings, categories: state.categories, parts: state.parts, templates: orderedTemplates } });
            DOMElements.newJsonNameInput.value = '';
            saveJsonConfigs(); renderJsonConfigs(); showNotification('設定を保存しました。');
        });
        DOMElements.jsonList.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action]'); if (!target) return; const index = parseInt(target.dataset.index);
            if (target.dataset.action === 'switch') {
                if (index !== activeConfigIndex) {
                    updateCurrentConfig();
                    activeConfigIndex = index; const config = jsonConfigs[activeConfigIndex].data;
                    state.settings = config.settings || { translationApiUrl: '' };
                    state.categories = config.categories || ['スタイル', 'キャラクター', '背景', '品質向上', 'ネガティブプロンプト', 'カテゴリなし'];
                    state.parts = config.parts || [];
                    state.templates = config.templates || [];
                    state.isApiRegistered = !!state.settings.translationApiUrl;
                    DOMElements.translationApiUrlInput.value = state.settings.translationApiUrl;
                    saveJsonConfigs(); saveData(); renderAll(); showNotification(`「${jsonConfigs[activeConfigIndex].name}」に切り替えました。`);
                }
            } else if (target.dataset.action === 'delete') {
                if (jsonConfigs.length > 1) {
                    const configName = jsonConfigs[index].name;
                    if (confirm(`設定「${configName}」を削除しますか？`)) {
                        jsonConfigs.splice(index, 1);
                        if (activeConfigIndex >= index) activeConfigIndex = Math.max(0, activeConfigIndex - 1);
                        saveJsonConfigs(); renderJsonConfigs(); showNotification('設定を削除しました。');
                    }
                }
            }
        });
        DOMElements.duplicateJsonBtn.addEventListener('click', () => {
            const baseName = jsonConfigs[activeConfigIndex].name;
            let newName = baseName + ' (コピー)'; let counter = 1;
            while (jsonConfigs.find((c) => c.name === newName)) { newName = baseName + ` (コピー${counter})`; counter++; }
            jsonConfigs.push({ name: newName, data: JSON.parse(JSON.stringify(jsonConfigs[activeConfigIndex].data)) });
            saveJsonConfigs(); renderJsonConfigs(); showNotification('設定を複製しました。');
        });
        DOMElements.renameJsonBtn.addEventListener('click', () => {
            const currentName = jsonConfigs[activeConfigIndex].name;
            const newName = prompt('新しい設定名を入力してください:', currentName);
            if (newName && newName.trim() && newName !== currentName) {
                if (jsonConfigs.find((c) => c.name === newName.trim())) { showNotification('同じ名前の設定が既に存在します。', 'error'); return; }
                jsonConfigs[activeConfigIndex].name = newName.trim();
                saveJsonConfigs(); renderJsonConfigs(); showNotification('設定名を変更しました。');
            }
        });

        // Raw data editor modal
        DOMElements.editRawDataBtn.addEventListener('click', () => {
            const prettyJson = JSON.stringify(JSON.parse(localStorage.getItem('promptManagerData') || '{}'), null, 2);
            DOMElements.dataEditorTextarea.value = prettyJson;
            DOMElements.dataEditorModal.style.display = 'flex';
        });
        const closeModal = () => { DOMElements.dataEditorModal.style.display = 'none'; };
        DOMElements.closeDataEditorBtn.addEventListener('click', closeModal);
        DOMElements.cancelDataEditorBtn.addEventListener('click', closeModal);
        DOMElements.saveDataFromEditorBtn.addEventListener('click', () => {
            try {
                const editedJson = DOMElements.dataEditorTextarea.value;
                const parsedData = JSON.parse(editedJson);
                // テンプレートのキー順を統一
                if (parsedData.templates) {
                    parsedData.templates = parsedData.templates.map(t => ({
                        id: t.id,
                        name: t.name,
                        prompt: t.prompt,
                        translation: t.translation,
                        desc: t.desc,
                        thumbnail: t.thumbnail
                    }));
                }
                if (confirm('現在のすべてのデータが上書きされます。よろしいですか？')) {
                    localStorage.setItem('promptManagerData', JSON.stringify(parsedData));
                    closeModal(); location.reload();
                }
            } catch (error) { showNotification('JSONの形式が正しくありません。\nエラー: ' + error.message, 'error'); }
        });

        // Reset all data
        DOMElements.resetDataBtn.addEventListener('click', () => {
            if (confirm('すべてのデータが初期状態にリセットされます。\n（カテゴリ、パーツ、テンプレート、翻訳API）\nこの操作は元に戻せません。\n\n本当に実行しますか？')) {
                state = {
                    parts: defaultParts.map((p) => ({ ...p, id: generateId() })),
                    templates: [],
                    categories: ['スタイル', 'キャラクター', '背景', '品質向上', 'ネガティブプロンプト', 'カテゴリなし'],
                    settings: { translationApiUrl: '' },
                    currentPrompt: { en: '', ja: '' },
                    categoryStates: {},
                    clickedPartIdsInSession: new Set(),
                    selectedPartIdsForBulkEdit: new Set(),
                    editingPartId: null,
                    editingTemplateId: null,
                    isApiRegistered: false,
                };
                // テンプレートのキー順を統一
                const orderedTemplates = state.templates.map(t => ({
                    id: t.id,
                    name: t.name,
                    prompt: t.prompt,
                    translation: t.translation,
                    desc: t.desc,
                    thumbnail: t.thumbnail
                }));
                jsonConfigs = [{ name: 'デフォルト', data: { settings: state.settings, categories: state.categories, parts: state.parts, templates: orderedTemplates } }];
                activeConfigIndex = 0;
                localStorage.removeItem('promptManagerData');
                localStorage.removeItem('promptManagerCurrentPrompt');
                saveJsonConfigs();
                saveData();
                renderAll();
                showNotification('データを初期化しました。');
            }
        });

        function setupImageModalInit() { setupImageModal(); }

        // Init
        function init() { loadJsonConfigs(); loadData(); renderAll(); setupThumbnailHandlers(); setupImageModalInit(); checkStorageSize(); }
        init();
    });
    </script>
</body>
</html>
